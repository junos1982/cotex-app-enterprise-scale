name: Run Azure CLI Login with OpenID Connect
on: [push]

jobs:
  test:
    permissions:
      id-token: write # Require write permission to Fetch an OIDC token.

    runs-on: ubuntu-latest
    steps:
    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Azure CLI script
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az account show
          # You can write your Azure CLI inline scripts here.

    - name: Ensure cotex-basic-vm exists
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          set -euo pipefail

          VM_NAME="cotex-basic-vm"
          RG_NAME="rg-cotex-git"

          if az vm show --resource-group "${RG_NAME}" --name "${VM_NAME}" >/dev/null 2>&1; then
            echo "Virtual machine ${VM_NAME} already exists in ${RG_NAME}, skipping creation."
          else
            az vm create \
              --resource-group "${RG_NAME}" \
              --name "${VM_NAME}" \
              --image Ubuntu2204 \
              --size Standard_B1s \
              --admin-username azureuser \
              --generate-ssh-keys \
              --tags 생성자="이동준"
          fi
